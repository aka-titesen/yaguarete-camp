# üîå Sprint 2: API Backend y Servicios Base

**Duraci√≥n**: 2 semanas  
**Fecha inicio**: [Definir]  
**Fecha fin**: [Definir]  
**Responsable**: [Asignar]  
**Dependencias**: Sprint 1 completado

---

## üéØ Objetivos del Sprint

1. Crear endpoints REST en CodeIgniter 4 para todas las entidades principales
2. Implementar sistema de autenticaci√≥n JWT robusto
3. Configurar servicios frontend para consumir API
4. Establecer React Query para manejo de estado servidor
5. Crear custom hooks para operaciones comunes

---

## üìã Backlog del Sprint

### üîß **Tareas Backend - CodeIgniter (Estimaci√≥n: 32h)**

#### 1. Configuraci√≥n Base API (8h)

- [ ] **1.1** Crear estructura de carpetas para API:
  ```
  app/Controllers/API/
  ‚îú‚îÄ‚îÄ BaseApiController.php
  ‚îú‚îÄ‚îÄ ProductosController.php
  ‚îú‚îÄ‚îÄ CategoriasController.php
  ‚îú‚îÄ‚îÄ UsuariosController.php
  ‚îú‚îÄ‚îÄ VentasController.php
  ‚îî‚îÄ‚îÄ AuthController.php
  ```
- [ ] **1.2** Crear `BaseApiController` con m√©todos comunes
- [ ] **1.3** Configurar CORS en `app/Config/Cors.php`
- [ ] **1.4** Configurar rutas API en `app/Config/Routes.php`
- [ ] **1.5** Crear middleware para validaci√≥n API

#### 2. Autenticaci√≥n JWT (10h)

- [ ] **2.1** Instalar Firebase JWT library:
  ```bash
  composer require firebase/php-jwt
  ```
- [ ] **2.2** Crear `AuthController` con endpoints:
  - `POST /api/auth/login`
  - `POST /api/auth/registro`
  - `POST /api/auth/refresh`
  - `POST /api/auth/logout`
- [ ] **2.3** Crear middleware JWT para proteger rutas
- [ ] **2.4** Implementar refresh token mechanism
- [ ] **2.5** Configurar tiempo de expiraci√≥n y claves secretas

#### 3. Endpoints de Productos (8h)

- [ ] **3.1** `ProductosController` con endpoints:
  ```php
  GET    /api/productos              # Listar con filtros
  GET    /api/productos/{id}         # Detalle espec√≠fico
  GET    /api/productos/destacados   # Productos destacados
  GET    /api/productos/relacionados/{id} # Productos relacionados
  GET    /api/productos/buscar       # B√∫squeda con query
  ```
- [ ] **3.2** Implementar paginaci√≥n est√°ndar
- [ ] **3.3** Agregar filtros por categor√≠a, precio, estado
- [ ] **3.4** Optimizar queries para performance
- [ ] **3.5** Agregar validaci√≥n de par√°metros

#### 4. Endpoints de Categor√≠as (3h)

- [ ] **4.1** `CategoriasController` con endpoints:
  ```php
  GET /api/categorias              # Listar todas
  GET /api/categorias/{id}         # Detalle categor√≠a
  GET /api/categorias/{id}/productos # Productos de categor√≠a
  ```
- [ ] **4.2** Incluir subcategor√≠as en response
- [ ] **4.3** Contar productos por categor√≠a

#### 5. Endpoints de Usuario (3h)

- [ ] **5.1** `UsuariosController` con endpoints:
  ```php
  GET    /api/usuario/perfil       # Perfil del usuario logueado
  PUT    /api/usuario/perfil       # Actualizar perfil
  GET    /api/usuario/pedidos      # Historial de pedidos
  POST   /api/usuario/direccion    # Agregar direcci√≥n
  ```
- [ ] **5.2** Proteger endpoints con middleware JWT
- [ ] **5.3** Validar permisos de usuario

---

### üîß **Tareas Frontend - React (Estimaci√≥n: 28h)**

#### 6. Configuraci√≥n de Axios (6h)

- [ ] **6.1** Crear instancia de Axios configurada:
  ```javascript
  // services/api.js
  const api = axios.create({
    baseURL: import.meta.env.VITE_API_URL,
    timeout: 10000,
    headers: {
      "Content-Type": "application/json",
    },
  });
  ```
- [ ] **6.2** Configurar interceptores de request:
  - Agregar token JWT autom√°ticamente
  - Logging de requests en desarrollo
- [ ] **6.3** Configurar interceptores de response:
  - Manejo global de errores
  - Refresh autom√°tico de tokens
  - Normalizaci√≥n de responses
- [ ] **6.4** Crear tipos de error personalizados
- [ ] **6.5** Configurar retry autom√°tico para fallos temporales

#### 7. Servicios de API (10h)

- [ ] **7.1** Crear `authService.js`:
  ```javascript
  export const authService = {
    login: (credentials) => api.post("/auth/login", credentials),
    register: (userData) => api.post("/auth/registro", userData),
    logout: () => api.post("/auth/logout"),
    refreshToken: () => api.post("/auth/refresh"),
    getProfile: () => api.get("/usuario/perfil"),
  };
  ```
- [ ] **7.2** Crear `productosService.js`:
  ```javascript
  export const productosService = {
    getAll: (params) => api.get("/productos", { params }),
    getById: (id) => api.get(`/productos/${id}`),
    getDestacados: () => api.get("/productos/destacados"),
    search: (query) => api.get("/productos/buscar", { params: { q: query } }),
  };
  ```
- [ ] **7.3** Crear `categoriasService.js`
- [ ] **7.4** Crear `usuarioService.js`
- [ ] **7.5** Agregar TypeScript types para responses (opcional)

#### 8. Configuraci√≥n React Query (6h)

- [ ] **8.1** Configurar QueryClient en `main.jsx`:

  ```javascript
  import { QueryClient, QueryClientProvider } from "@tanstack/react-query";

  const queryClient = new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 5 * 60 * 1000, // 5 minutos
        retry: 2,
        refetchOnWindowFocus: false,
      },
    },
  });
  ```

- [ ] **8.2** Configurar React Query DevTools
- [ ] **8.3** Crear query keys constants:
  ```javascript
  export const QUERY_KEYS = {
    PRODUCTOS: ["productos"],
    PRODUCTO: (id) => ["productos", id],
    CATEGORIAS: ["categorias"],
    USER_PROFILE: ["user", "profile"],
  };
  ```
- [ ] **8.4** Configurar error boundary para queries
- [ ] **8.5** Implementar cache invalidation strategies

#### 9. Custom Hooks (6h)

- [ ] **9.1** Crear `useAuth()` hook:
  ```javascript
  export const useAuth = () => {
    const login = useMutation({
      mutationFn: authService.login,
      onSuccess: (data) => {
        // Store token, redirect user
      },
    });

    const { data: user } = useQuery({
      queryKey: QUERY_KEYS.USER_PROFILE,
      queryFn: authService.getProfile,
      enabled: !!token,
    });

    return { login, user, logout, isAuthenticated };
  };
  ```
- [ ] **9.2** Crear `useProductos()` hook:
  ```javascript
  export const useProductos = (filters = {}) => {
    return useQuery({
      queryKey: [...QUERY_KEYS.PRODUCTOS, filters],
      queryFn: () => productosService.getAll(filters),
      keepPreviousData: true,
    });
  };
  ```
- [ ] **9.3** Crear `useProducto(id)` hook para detalle
- [ ] **9.4** Crear `useCategorias()` hook
- [ ] **9.5** Agregar loading y error states a todos los hooks

---

### üîí **Tareas de Seguridad (Estimaci√≥n: 8h)**

#### 10. Seguridad Backend (6h)

- [ ] **10.1** Configurar CSRF protection para formularios
- [ ] **10.2** Implementar rate limiting en endpoints cr√≠ticos
- [ ] **10.3** Validar y sanitizar todos los inputs
- [ ] **10.4** Configurar headers de seguridad:
  ```php
  header('X-Content-Type-Options: nosniff');
  header('X-Frame-Options: DENY');
  header('X-XSS-Protection: 1; mode=block');
  ```
- [ ] **10.5** Logging de intentos de login fallidos
- [ ] **10.6** Configurar HTTPS en producci√≥n

#### 11. Seguridad Frontend (2h)

- [ ] **11.1** Configurar Content Security Policy b√°sico
- [ ] **11.2** Validar tokens JWT en frontend
- [ ] **11.3** Implementar logout autom√°tico por inactividad
- [ ] **11.4** Evitar XSS en rendering de datos de API

---

### üìö **Tareas de Documentaci√≥n (Estimaci√≥n: 8h)**

#### 12. Documentaci√≥n de API (6h)

- [ ] **12.1** Crear documentaci√≥n Swagger/OpenAPI
- [ ] **12.2** Documentar todos los endpoints con ejemplos:
  ```yaml
  /api/productos:
    get:
      summary: Lista productos con filtros
      parameters:
        - name: categoria
          in: query
          schema:
            type: integer
        - name: precio_min
          in: query
          schema:
            type: number
      responses:
        200:
          description: Lista de productos
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Producto"
  ```
- [ ] **12.3** Documentar esquemas de autenticaci√≥n
- [ ] **12.4** Incluir c√≥digos de error est√°ndar
- [ ] **12.5** Crear ejemplos de request/response

#### 13. Documentaci√≥n Frontend (2h)

- [ ] **13.1** Documentar servicios y hooks en c√≥digo
- [ ] **13.2** Crear README de servicios con ejemplos de uso
- [ ] **13.3** Documentar error handling patterns

---

## ‚úÖ Criterios de Aceptaci√≥n

### Backend:

- [ ] Todos los endpoints responden correctamente con status codes apropiados
- [ ] Autenticaci√≥n JWT funciona end-to-end
- [ ] CORS configurado correctamente para desarrollo y producci√≥n
- [ ] Paginaci√≥n funciona en endpoints que retornan listas
- [ ] Validaci√≥n de datos funciona en todos los endpoints
- [ ] Rate limiting funciona en endpoints cr√≠ticos

### Frontend:

- [ ] Servicios pueden hacer calls exitosos a todos los endpoints
- [ ] React Query cachea datos correctamente
- [ ] Error handling funciona para casos como 401, 404, 500
- [ ] Custom hooks proporcionan interface limpia para componentes
- [ ] Token refresh funciona autom√°ticamente
- [ ] Loading states se muestran apropiadamente

### Seguridad:

- [ ] Endpoints protegidos requieren autenticaci√≥n v√°lida
- [ ] Tokens JWT expiran y se refrescan correctamente
- [ ] No hay vulnerabilidades b√°sicas (SQL injection, XSS)
- [ ] HTTPS funciona en ambiente de staging

### Performance:

- [ ] Endpoints responden en <200ms para queries simples
- [ ] React Query evita requests duplicados
- [ ] Paginaci√≥n maneja listas grandes eficientemente
- [ ] Bundle size no aument√≥ significativamente

---

## üéØ Definition of Done

### Para Endpoints:

1. **Funcionalidad**: Endpoint responde seg√∫n especificaci√≥n
2. **Validaci√≥n**: Valida correctamente inputs y retorna errores apropiados
3. **Seguridad**: Implementa autenticaci√≥n/autorizaci√≥n si es necesario
4. **Testing**: Tests unitarios y de integraci√≥n pasando
5. **Documentaci√≥n**: Documentado en Swagger con ejemplos
6. **Performance**: Optimizado para cargas esperadas

### Para Servicios Frontend:

1. **Funcionalidad**: Service conecta exitosamente con API
2. **Error Handling**: Maneja todos los casos de error gracefully
3. **Types**: TypeScript types definidos (si aplica)
4. **Testing**: Unit tests para l√≥gica cr√≠tica
5. **Hook Integration**: Integrado con custom hooks apropiados
6. **Documentation**: Ejemplos de uso documentados

---

## üö® Riesgos y Mitigaciones

### Riesgo 1: Performance de API con datos reales

**Probabilidad**: Media | **Impacto**: Alto
**Mitigaci√≥n**: Implementar paginaci√≥n desde el inicio, optimizar queries, agregar indices de BD

### Riesgo 2: Complejidad del refresh token

**Probabilidad**: Alta | **Impacto**: Medio
**Mitigaci√≥n**: Usar librer√≠a probada, implementar fallback a re-login manual

### Riesgo 3: CORS issues en diferentes ambientes

**Probabilidad**: Media | **Impacto**: Medio
**Mitigaci√≥n**: Configurar CORS correctamente desde el inicio, testear en m√∫ltiples ambientes

### Riesgo 4: Sincronizaci√≥n estado cliente-servidor

**Probabilidad**: Media | **Impacto**: Alto
**Mitigaci√≥n**: Usar React Query apropiadamente, implementar optimistic updates donde sea apropiado

---

## üìä M√©tricas del Sprint

### API Performance:

- **Response Time**: <200ms para 95% de requests
- **Throughput**: >100 requests/segundo
- **Error Rate**: <1%
- **Uptime**: >99.5%

### Frontend Performance:

- **First API Call**: <500ms
- **Cache Hit Rate**: >80% despu√©s del primer load
- **Bundle Size Increase**: <100KB
- **Memory Usage**: No memory leaks detectables

### Quality:

- **Test Coverage**: >85% en c√≥digo nuevo
- **API Documentation Coverage**: 100% de endpoints documentados
- **Security Scan**: 0 vulnerabilidades cr√≠ticas o altas

---

## üìÖ Hitos Importantes

### Fin Semana 1:

- [ ] Endpoints b√°sicos funcionando (productos, categor√≠as)
- [ ] Autenticaci√≥n JWT implementada
- [ ] Servicios frontend conectando exitosamente

### Fin Semana 2:

- [ ] Todos los endpoints completos y documentados
- [ ] React Query configurado y funcionando
- [ ] Custom hooks creados y testeados
- [ ] Documentaci√≥n completa

---

## üîÑ Daily Checklist

### Para Backend:

- [ ] ¬øEndpoint responde con formato JSON consistente?
- [ ] ¬øValidaciones de input implementadas?
- [ ] ¬øHeaders de seguridad configurados?
- [ ] ¬øLogging apropiado agregado?

### Para Frontend:

- [ ] ¬øService maneja errors gracefully?
- [ ] ¬øReact Query configurado apropiadamente?
- [ ] ¬øLoading states implementados?
- [ ] ¬øTipos de datos consistentes?

---

## üìñ Recursos de Referencia

### Backend:

- [CodeIgniter 4 RESTful Guide](https://codeigniter.com/user_guide/incoming/restful.html)
- [Firebase JWT PHP Library](https://github.com/firebase/php-jwt)
- [API Security Best Practices](https://owasp.org/www-project-api-security/)

### Frontend:

- [React Query Documentation](https://tanstack.com/query/v4)
- [Axios Documentation](https://axios-http.com/docs/intro)
- [Custom Hooks Best Practices](https://reactjs.org/docs/hooks-custom.html)

---

_Sprint creado: [Fecha]_  
_√öltima actualizaci√≥n: [Fecha]_

# ๐๏ธ Estructura MVC - Yagaruete Camp

## ๐ Descripciรณn General

Yagaruete Camp implementa el patrรณn **Model-View-Controller (MVC)** siguiendo las convenciones de CodeIgniter 4. Esta arquitectura garantiza separaciรณn de responsabilidades, mantenibilidad y escalabilidad del cรณdigo.

## ๐๏ธ Arquitectura MVC

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        REQUEST FLOW                             โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     ROUTER                                      โ
โ                 Routes.php                                      โ
โ               โข URL Parsing                                     โ
โ               โข Route Matching                                  โ
โ               โข Controller Resolution                           โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   FILTERS                                       โ
โ                 โข Authentication                                โ
โ                 โข Authorization                                 โ
โ                 โข CORS                                          โ
โ                 โข Rate Limiting                                 โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 CONTROLLERS                                     โ
โ               โข Request Handling                                โ
โ               โข Business Logic Coordination                     โ
โ               โข Response Generation                             โ
โ                                                                 โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ             โ
โ  โ    Auth     โ  โ Products    โ  โ   Sales     โ             โ
โ  โControllers  โ  โControllers  โ  โControllers  โ             โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ             โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
                  โ                                 โ
                  โผ                                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               MODELS                โ โ         VIEWS           โ
โ            โข Data Access            โ โ      โข Presentation     โ
โ            โข Business Rules         โ โ      โข Templates        โ
โ            โข Validation             โ โ      โข UI Logic         โ
โ                                     โ โ                         โ
โ  โโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโ   โ โ  โโโโโโโโโโโโโโโ       โ
โ  โ   Usuario   โ โ  Producto   โ   โ โ  โ  Frontend   โ       โ
โ  โ   Model     โ โ   Model     โ   โ โ  โ   Views     โ       โ
โ  โโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโ   โ โ  โโโโโโโโโโโโโโโ       โ
โ                                     โ โ                         โ
โ  โโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโ   โ โ  โโโโโโโโโโโโโโโ       โ
โ  โ   Ventas    โ โ Categories  โ   โ โ  โ  Backend    โ       โ
โ  โ   Model     โ โ   Model     โ   โ โ  โ   Views     โ       โ
โ  โโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโ   โ โ  โโโโโโโโโโโโโโโ       โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      DATABASE                                   โ
โ                    MySQL 8.0                                    โ
โ                 โข Data Persistence                              โ
โ                 โข ACID Transactions                             โ
โ                 โข Referential Integrity                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ Controllers (Controladores)

Los controladores coordinan la lรณgica de la aplicaciรณn y actรบan como intermediarios entre Models y Views.

### ๐ Estructura de Controladores

```
app/Controllers/
โโโ BaseController.php           # Controlador base comรบn
โโโ Home.php                     # Pรกgina principal
โโโ LoginController.php          # Autenticaciรณn y sesiones
โโโ UsuarioCrudController.php    # CRUD de usuarios
โโโ ProductoController.php       # Gestiรณn de productos
โโโ CarritoController.php        # Carrito de compras
โโโ VentasController.php         # Gestiรณn de ventas
โโโ ConsultasController.php      # Formulario de contacto
โโโ API/                         # Endpoints API REST
    โโโ AuthController.php       # API de autenticaciรณn
    โโโ ProductsController.php   # API de productos
    โโโ SalesController.php      # API de ventas
```

### ๐๏ธ BaseController

**Archivo**: `app/Controllers/BaseController.php`

```php
<?php

namespace App\Controllers;

use CodeIgniter\Controller;
use CodeIgniter\HTTP\CLIRequest;
use CodeIgniter\HTTP\IncomingRequest;
use CodeIgniter\HTTP\RequestInterface;
use CodeIgniter\HTTP\ResponseInterface;
use Psr\Log\LoggerInterface;

abstract class BaseController extends Controller
{
    /**
     * Instance of the main Request object.
     */
    protected $request;

    /**
     * Helpers que se cargan automรกticamente
     */
    protected $helpers = ['url', 'form', 'security'];

    /**
     * Constructor base
     */
    public function initController(RequestInterface $request, ResponseInterface $response, LoggerInterface $logger)
    {
        parent::initController($request, $response, $logger);

        // Validar sesiรณn en todos los controladores
        $this->validateSession();

        // Cargar datos comunes para todas las vistas
        $this->loadCommonData();
    }

    /**
     * Validar sesiรณn del usuario
     */
    protected function validateSession()
    {
        $session = session();

        // Regenerar ID de sesiรณn por seguridad
        if (!$session->has('session_regenerated')) {
            $session->regenerate();
            $session->set('session_regenerated', true);
        }

        // Log de acceso
        log_message('info', 'Access: ' . $this->request->getPath() . ' from ' . $this->request->getIPAddress());
    }

    /**
     * Cargar datos comunes para vistas
     */
    protected function loadCommonData()
    {
        $session = session();

        $this->data = [
            'usuario_logueado' => $session->get('usuario_logueado'),
            'perfil_id' => $session->get('perfil_id'),
            'usuario_nombre' => $session->get('usuario_nombre'),
            'carrito_count' => $this->getCarritoCount(),
            'current_url' => current_url()
        ];
    }

    /**
     * Obtener cantidad de items en carrito
     */
    protected function getCarritoCount()
    {
        $session = session();
        $carrito = $session->get('carrito') ?? [];

        return array_sum(array_column($carrito, 'cantidad'));
    }

    /**
     * Verificar si usuario estรก autenticado
     */
    protected function isLoggedIn()
    {
        return session()->get('usuario_logueado') ?? false;
    }

    /**
     * Verificar si usuario es administrador
     */
    protected function isAdmin()
    {
        return session()->get('perfil_id') == 1;
    }

    /**
     * Redirigir con mensaje
     */
    protected function redirectWithMessage($url, $message, $type = 'success')
    {
        session()->setFlashdata($type, $message);
        return redirect()->to($url);
    }
}
```

### ๐ LoginController

**Archivo**: `app/Controllers/LoginController.php`

**Responsabilidades**:

- Autenticaciรณn de usuarios
- Gestiรณn de sesiones
- Logout seguro
- Validaciรณn de credenciales

```php
class LoginController extends BaseController
{
    protected $usuariosModel;

    public function __construct()
    {
        $this->usuariosModel = new UsuariosModel();
    }

    /**
     * Mostrar formulario de login
     */
    public function index()
    {
        // Si ya estรก logueado, redirigir
        if ($this->isLoggedIn()) {
            return $this->redirectBasedOnRole();
        }

        return view('front/login', $this->data);
    }

    /**
     * Procesar login
     */
    public function authenticate()
    {
        $validation = \Config\Services::validation();
        $validation->setRules([
            'email' => 'required|valid_email',
            'password' => 'required|min_length[6]'
        ]);

        if (!$validation->withRequest($this->request)->run()) {
            return view('front/login', [
                'validation' => $validation,
                'input' => $this->request->getPost()
            ]);
        }

        $email = $this->request->getPost('email');
        $password = $this->request->getPost('password');

        $user = $this->usuariosModel->validateUser($email, $password);

        if ($user) {
            $this->setUserSession($user);
            return $this->redirectBasedOnRole();
        } else {
            return $this->redirectWithMessage('login', 'Credenciales invรกlidas', 'error');
        }
    }

    /**
     * Establecer sesiรณn de usuario
     */
    private function setUserSession($user)
    {
        $session = session();
        $session->set([
            'usuario_logueado' => true,
            'usuario_id' => $user->id,
            'usuario_nombre' => $user->nombre,
            'usuario_email' => $user->email,
            'perfil_id' => $user->perfil_id
        ]);

        // Log del login exitoso
        log_message('info', "User login: {$user->email} (ID: {$user->id})");
    }

    /**
     * Redirigir segรบn rol
     */
    private function redirectBasedOnRole()
    {
        $perfilId = session()->get('perfil_id');

        return match($perfilId) {
            1 => redirect()->to('admin/dashboard'),  // Admin
            2 => redirect()->to('/'),                // Cliente
            default => redirect()->to('login')
        };
    }

    /**
     * Cerrar sesiรณn
     */
    public function logout()
    {
        $session = session();

        // Log del logout
        $email = $session->get('usuario_email');
        log_message('info', "User logout: {$email}");

        // Destruir sesiรณn
        $session->destroy();

        return $this->redirectWithMessage('/', 'Sesiรณn cerrada correctamente');
    }
}
```

### ๐๏ธ ProductoController

**Archivo**: `app/Controllers/ProductoController.php`

**Responsabilidades**:

- CRUD de productos
- Bรบsqueda y filtrado
- Gestiรณn de imรกgenes
- Validaciรณn de stock

```php
class ProductoController extends BaseController
{
    protected $productoModel;
    protected $categoriasModel;

    public function __construct()
    {
        $this->productoModel = new ProductoModel();
        $this->categoriasModel = new CategoriasModel();
    }

    /**
     * Listar productos (Frontend)
     */
    public function index()
    {
        $productos = $this->productoModel->getProductosActivos();
        $categorias = $this->categoriasModel->getCategoriasActivas();

        $this->data['productos'] = $productos;
        $this->data['categorias'] = $categorias;

        return view('front/productos/index', $this->data);
    }

    /**
     * Ver detalle de producto
     */
    public function detalle($id)
    {
        $producto = $this->productoModel->getProductoCompleto($id);

        if (!$producto) {
            throw new \CodeIgniter\Exceptions\PageNotFoundException('Producto no encontrado');
        }

        $this->data['producto'] = $producto;
        $this->data['relacionados'] = $this->productoModel->getProductosRelacionados($producto->categoria_id, $id);

        return view('front/productos/detalle', $this->data);
    }

    /**
     * Gestiรณn de productos (Backend)
     */
    public function admin()
    {
        // Solo administradores
        if (!$this->isAdmin()) {
            throw new \CodeIgniter\Exceptions\PageNotFoundException();
        }

        $productos = $this->productoModel->getProductosConCategoria();
        $this->data['productos'] = $productos;

        return view('back/productos/index', $this->data);
    }

    /**
     * Crear producto
     */
    public function crear()
    {
        if (!$this->isAdmin()) {
            throw new \CodeIgniter\Exceptions\PageNotFoundException();
        }

        if ($this->request->getMethod() === 'POST') {
            return $this->procesarFormulario();
        }

        $this->data['categorias'] = $this->categoriasModel->findAll();
        return view('back/productos/crear', $this->data);
    }

    /**
     * Procesar formulario de producto
     */
    private function procesarFormulario($id = null)
    {
        $validation = $this->getValidationRules();

        if (!$validation->withRequest($this->request)->run()) {
            $this->data['validation'] = $validation;
            $this->data['categorias'] = $this->categoriasModel->findAll();
            $view = $id ? 'back/productos/editar' : 'back/productos/crear';
            return view($view, $this->data);
        }

        $data = $this->prepareProductData();

        // Procesar imagen si se subiรณ
        $imagen = $this->request->getFile('imagen');
        if ($imagen && $imagen->isValid()) {
            $data['imagen'] = $this->processImage($imagen);
        }

        try {
            if ($id) {
                $this->productoModel->update($id, $data);
                $message = 'Producto actualizado correctamente';
            } else {
                $this->productoModel->insert($data);
                $message = 'Producto creado correctamente';
            }

            return $this->redirectWithMessage('admin/productos', $message);
        } catch (\Exception $e) {
            log_message('error', 'Error saving product: ' . $e->getMessage());
            return $this->redirectWithMessage('admin/productos', 'Error al guardar producto', 'error');
        }
    }

    /**
     * Reglas de validaciรณn
     */
    private function getValidationRules()
    {
        $validation = \Config\Services::validation();
        $validation->setRules([
            'nombre' => 'required|min_length[3]|max_length[255]',
            'descripcion' => 'required|min_length[10]',
            'precio' => 'required|decimal|greater_than[0]',
            'stock' => 'required|integer|greater_than_equal_to[0]',
            'categoria_id' => 'required|integer',
            'imagen' => 'if_exist|uploaded[imagen]|max_size[imagen,2048]|is_image[imagen]'
        ]);

        return $validation;
    }

    /**
     * Preparar datos del producto
     */
    private function prepareProductData()
    {
        return [
            'nombre' => $this->request->getPost('nombre'),
            'descripcion' => $this->request->getPost('descripcion'),
            'precio' => $this->request->getPost('precio'),
            'stock' => $this->request->getPost('stock'),
            'categoria_id' => $this->request->getPost('categoria_id'),
            'activo' => $this->request->getPost('activo') ? 1 : 0
        ];
    }

    /**
     * Procesar imagen subida
     */
    private function processImage($imagen)
    {
        $nombreArchivo = $imagen->getRandomName();
        $imagen->move(WRITEPATH . 'uploads/productos', $nombreArchivo);

        // Redimensionar imagen si es necesario
        $this->resizeImage(WRITEPATH . 'uploads/productos/' . $nombreArchivo);

        return $nombreArchivo;
    }
}
```

## ๐๏ธ Models (Modelos)

Los modelos manejan la lรณgica de datos y las reglas de negocio.

### ๐ Estructura de Modelos

```
app/Models/
โโโ BaseModel.php               # Modelo base comรบn
โโโ UsuariosModel.php          # Gestiรณn de usuarios
โโโ ProductoModel.php          # Gestiรณn de productos
โโโ CategoriasModel.php        # Gestiรณn de categorรญas
โโโ VentasCabeceraModel.php    # Cabeceras de ventas
โโโ VentasDetalleModel.php     # Detalles de ventas
โโโ ConsultasModel.php         # Consultas de contacto
```

### ๐๏ธ BaseModel

**Archivo**: `app/Models/BaseModel.php`

```php
<?php

namespace App\Models;

use CodeIgniter\Model;

class BaseModel extends Model
{
    protected $returnType = 'object';
    protected $useSoftDeletes = false;
    protected $useTimestamps = true;
    protected $createdField = 'created_at';
    protected $updatedField = 'updated_at';

    /**
     * Validaciรณn comรบn
     */
    protected $validationRules = [];
    protected $validationMessages = [];

    /**
     * Obtener registros activos
     */
    public function getActive()
    {
        return $this->where('activo', 1)->findAll();
    }

    /**
     * Activar/Desactivar registro
     */
    public function toggleActive($id)
    {
        $record = $this->find($id);
        if (!$record) {
            throw new \Exception('Registro no encontrado');
        }

        return $this->update($id, ['activo' => !$record->activo]);
    }

    /**
     * Bรบsqueda paginada
     */
    public function getPaginated($perPage = 20, $conditions = [])
    {
        $builder = $this->builder();

        foreach ($conditions as $field => $value) {
            if (is_array($value)) {
                $builder->whereIn($field, $value);
            } else {
                $builder->where($field, $value);
            }
        }

        return $builder->paginate($perPage);
    }

    /**
     * Logging de operaciones
     */
    protected function logOperation($operation, $id = null, $data = null)
    {
        $message = sprintf(
            'Model %s: %s %s %s',
            get_class($this),
            $operation,
            $id ? "ID: $id" : '',
            $data ? json_encode($data) : ''
        );

        log_message('info', $message);
    }

    /**
     * Eventos del modelo
     */
    protected function beforeInsert(array $data)
    {
        $this->logOperation('INSERT', null, $data['data'] ?? null);
        return $data;
    }

    protected function beforeUpdate(array $data)
    {
        $this->logOperation('UPDATE', $data['id'][0] ?? null, $data['data'] ?? null);
        return $data;
    }

    protected function beforeDelete(array $data)
    {
        $this->logOperation('DELETE', $data['id'][0] ?? null);
        return $data;
    }
}
```

### ๐ฅ UsuariosModel

**Archivo**: `app/Models/UsuariosModel.php`

```php
class UsuariosModel extends BaseModel
{
    protected $table = 'usuarios';
    protected $primaryKey = 'id';
    protected $allowedFields = ['usuario', 'nombre', 'email', 'password', 'perfil_id', 'activo'];

    protected $validationRules = [
        'usuario' => 'required|min_length[3]|max_length[50]|is_unique[usuarios.usuario,id,{id}]',
        'nombre' => 'required|min_length[3]|max_length[255]',
        'email' => 'required|valid_email|is_unique[usuarios.email,id,{id}]',
        'password' => 'required|min_length[8]',
        'perfil_id' => 'required|integer|in_list[1,2]'
    ];

    /**
     * Validar usuario para login
     */
    public function validateUser($email, $password)
    {
        $user = $this->where('email', $email)
                    ->where('activo', 1)
                    ->first();

        if ($user && password_verify($password, $user->password)) {
            return $user;
        }

        return false;
    }

    /**
     * Crear usuario con password hasheado
     */
    public function createUser($data)
    {
        if (isset($data['password'])) {
            $data['password'] = password_hash($data['password'], PASSWORD_DEFAULT);
        }

        return $this->insert($data);
    }

    /**
     * Obtener usuarios por perfil
     */
    public function getUsersByProfile($perfilId)
    {
        return $this->where('perfil_id', $perfilId)
                   ->where('activo', 1)
                   ->findAll();
    }

    /**
     * Verificar si usuario puede ser eliminado
     */
    public function canBeDeleted($id)
    {
        // No puede eliminar si tiene ventas asociadas
        $ventasModel = new VentasCabeceraModel();
        $ventas = $ventasModel->where('usuario_id', $id)->countAllResults();

        return $ventas === 0;
    }

    /**
     * Estadรญsticas de usuarios
     */
    public function getStats()
    {
        return [
            'total' => $this->countAllResults(),
            'activos' => $this->where('activo', 1)->countAllResults(),
            'administradores' => $this->where('perfil_id', 1)->countAllResults(),
            'clientes' => $this->where('perfil_id', 2)->countAllResults()
        ];
    }
}
```

### ๐๏ธ ProductoModel

**Archivo**: `app/Models/ProductoModel.php`

```php
class ProductoModel extends BaseModel
{
    protected $table = 'productos';
    protected $primaryKey = 'id';
    protected $allowedFields = ['nombre', 'descripcion', 'precio', 'stock', 'categoria_id', 'imagen', 'activo'];

    protected $validationRules = [
        'nombre' => 'required|min_length[3]|max_length[255]',
        'precio' => 'required|decimal|greater_than[0]',
        'stock' => 'required|integer|greater_than_equal_to[0]',
        'categoria_id' => 'permit_empty|integer'
    ];

    /**
     * Obtener productos con informaciรณn de categorรญa
     */
    public function getProductosConCategoria()
    {
        return $this->select('productos.*, categorias.nombre as categoria_nombre')
                   ->join('categorias', 'categorias.id = productos.categoria_id', 'left')
                   ->orderBy('productos.nombre')
                   ->findAll();
    }

    /**
     * Obtener productos activos
     */
    public function getProductosActivos($limit = null)
    {
        $builder = $this->select('productos.*, categorias.nombre as categoria_nombre')
                       ->join('categorias', 'categorias.id = productos.categoria_id', 'left')
                       ->where('productos.activo', 1)
                       ->where('productos.stock >', 0)
                       ->orderBy('productos.nombre');

        if ($limit) {
            $builder->limit($limit);
        }

        return $builder->findAll();
    }

    /**
     * Obtener producto completo
     */
    public function getProductoCompleto($id)
    {
        return $this->select('productos.*, categorias.nombre as categoria_nombre')
                   ->join('categorias', 'categorias.id = productos.categoria_id', 'left')
                   ->where('productos.id', $id)
                   ->first();
    }

    /**
     * Productos relacionados por categorรญa
     */
    public function getProductosRelacionados($categoriaId, $excludeId, $limit = 4)
    {
        return $this->where('categoria_id', $categoriaId)
                   ->where('id !=', $excludeId)
                   ->where('activo', 1)
                   ->where('stock >', 0)
                   ->limit($limit)
                   ->findAll();
    }

    /**
     * Buscar productos
     */
    public function searchProducts($term, $categoriaId = null)
    {
        $builder = $this->select('productos.*, categorias.nombre as categoria_nombre')
                       ->join('categorias', 'categorias.id = productos.categoria_id', 'left')
                       ->where('productos.activo', 1)
                       ->groupStart()
                           ->like('productos.nombre', $term)
                           ->orLike('productos.descripcion', $term)
                       ->groupEnd();

        if ($categoriaId) {
            $builder->where('productos.categoria_id', $categoriaId);
        }

        return $builder->findAll();
    }

    /**
     * Actualizar stock
     */
    public function updateStock($id, $cantidad)
    {
        $producto = $this->find($id);
        if (!$producto) {
            throw new \Exception('Producto no encontrado');
        }

        $newStock = $producto->stock + $cantidad;
        if ($newStock < 0) {
            throw new \Exception('Stock insuficiente');
        }

        return $this->update($id, ['stock' => $newStock]);
    }

    /**
     * Productos con stock bajo
     */
    public function getProductosStockBajo($limite = 5)
    {
        return $this->select('productos.*, categorias.nombre as categoria_nombre')
                   ->join('categorias', 'categorias.id = productos.categoria_id', 'left')
                   ->where('productos.activo', 1)
                   ->where('productos.stock <=', $limite)
                   ->orderBy('productos.stock', 'ASC')
                   ->findAll();
    }

    /**
     * Estadรญsticas de productos
     */
    public function getStats()
    {
        return [
            'total' => $this->countAllResults(),
            'activos' => $this->where('activo', 1)->countAllResults(),
            'sin_stock' => $this->where('stock', 0)->countAllResults(),
            'stock_bajo' => $this->where('stock <=', 5)->where('stock >', 0)->countAllResults(),
            'valor_inventario' => $this->selectSum('precio * stock', 'valor_total')->first()->valor_total ?? 0
        ];
    }
}
```

## ๐จ Views (Vistas)

Las vistas manejan la presentaciรณn e interfaz de usuario.

### ๐ Estructura de Vistas

```
app/Views/
โโโ layouts/                    # Layouts base
โ   โโโ main.php               # Layout principal del sitio
โ   โโโ admin.php              # Layout para panel admin
โ   โโโ auth.php               # Layout para autenticaciรณn
โโโ front/                     # Frontend pรบblico
โ   โโโ home.php               # Pรกgina principal
โ   โโโ login.php              # Formulario de login
โ   โโโ productos/             # Mรณdulo de productos
โ   โ   โโโ index.php          # Lista de productos
โ   โ   โโโ detalle.php        # Detalle de producto
โ   โโโ carrito/               # Carrito de compras
โ   โ   โโโ index.php          # Vista del carrito
โ   โ   โโโ checkout.php       # Proceso de compra
โ   โโโ contacto.php           # Formulario de contacto
โโโ back/                      # Backend administrativo
โ   โโโ dashboard.php          # Dashboard principal
โ   โโโ usuarios/              # Gestiรณn de usuarios
โ   โโโ productos/             # Gestiรณn de productos
โ   โโโ ventas/                # Gestiรณn de ventas
โโโ components/                # Componentes reutilizables
โ   โโโ navbar.php             # Barra de navegaciรณn
โ   โโโ footer.php             # Pie de pรกgina
โ   โโโ alerts.php             # Alertas y mensajes
โ   โโโ pagination.php         # Paginaciรณn
โโโ emails/                    # Templates de email
    โโโ welcome.php            # Email de bienvenida
    โโโ order_confirmation.php # Confirmaciรณn de pedido
```

### ๐ฏ Layout Principal

**Archivo**: `app/Views/layouts/main.php`

```php
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $title ?? 'Yagaruete Camp' ?></title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="<?= base_url('assets/css/style.css') ?>">

    <?= $this->section('css') ?>
</head>
<body>
    <!-- Navigation -->
    <?= $this->include('components/navbar') ?>

    <!-- Main Content -->
    <main class="container-fluid">
        <!-- Alerts -->
        <?= $this->include('components/alerts') ?>

        <!-- Page Content -->
        <?= $this->renderSection('content') ?>
    </main>

    <!-- Footer -->
    <?= $this->include('components/footer') ?>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="<?= base_url('assets/js/app.js') ?>"></script>

    <?= $this->section('js') ?>
</body>
</html>
```

### ๐งฉ Componentes Reutilizables

**Archivo**: `app/Views/components/navbar.php`

```php
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="<?= base_url() ?>">
            <i class="fas fa-mountain"></i>
            Yagaruete Camp
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="<?= base_url() ?>">Inicio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="<?= base_url('productos') ?>">Productos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="<?= base_url('contacto') ?>">Contacto</a>
                </li>
            </ul>

            <ul class="navbar-nav">
                <?php if ($usuario_logueado ?? false): ?>
                    <!-- Usuario logueado -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i>
                            <?= esc($usuario_nombre) ?>
                        </a>
                        <ul class="dropdown-menu">
                            <?php if (($perfil_id ?? 0) == 1): ?>
                                <li><a class="dropdown-item" href="<?= base_url('admin') ?>">Panel Admin</a></li>
                            <?php endif; ?>
                            <li><a class="dropdown-item" href="<?= base_url('perfil') ?>">Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="<?= base_url('mis-compras') ?>">Mis Compras</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="<?= base_url('logout') ?>">Cerrar Sesiรณn</a></li>
                        </ul>
                    </li>

                    <!-- Carrito -->
                    <?php if (($perfil_id ?? 0) == 2): ?>
                        <li class="nav-item">
                            <a class="nav-link position-relative" href="<?= base_url('carrito') ?>">
                                <i class="fas fa-shopping-cart"></i>
                                Carrito
                                <?php if (($carrito_count ?? 0) > 0): ?>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                        <?= $carrito_count ?>
                                    </span>
                                <?php endif; ?>
                            </a>
                        </li>
                    <?php endif; ?>
                <?php else: ?>
                    <!-- Usuario no logueado -->
                    <li class="nav-item">
                        <a class="nav-link" href="<?= base_url('login') ?>">
                            <i class="fas fa-sign-in-alt"></i>
                            Iniciar Sesiรณn
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="<?= base_url('registro') ?>">
                            <i class="fas fa-user-plus"></i>
                            Registrarse
                        </a>
                    </li>
                <?php endif; ?>
            </ul>
        </div>
    </div>
</nav>
```

## ๐ก๏ธ Filters (Filtros)

Los filtros manejan middleware y autenticaciรณn.

### ๐ Estructura de Filtros

```
app/Filters/
โโโ Auth.php                   # Autenticaciรณn general
โโโ Cliente.php               # Filtro para clientes
โโโ Admin.php                 # Filtro para administradores
โโโ CORS.php                  # Cross-Origin Resource Sharing
โโโ RateLimit.php            # Limitaciรณn de tasa
```

### ๐ Auth Filter

**Archivo**: `app/Filters/Auth.php`

```php
<?php

namespace App\Filters;

use CodeIgniter\Filters\FilterInterface;
use CodeIgniter\HTTP\RequestInterface;
use CodeIgniter\HTTP\ResponseInterface;

class Auth implements FilterInterface
{
    public function before(RequestInterface $request, $arguments = null)
    {
        $session = session();

        // Verificar si usuario estรก logueado
        if (!$session->get('usuario_logueado')) {
            // Guardar URL destino para redirigir despuรฉs del login
            $session->set('redirect_url', current_url());

            // Redirigir al login
            return redirect()->to('login');
        }

        // Verificar rol si se especifica
        if ($arguments && count($arguments) > 0) {
            $requiredRole = $arguments[0];
            $userRole = $session->get('perfil_id');

            if ($userRole != $requiredRole) {
                throw new \CodeIgniter\Exceptions\PageNotFoundException();
            }
        }

        // Log de acceso
        log_message('info', 'Auth filter: User ' . $session->get('usuario_email') . ' accessing ' . $request->getPath());
    }

    public function after(RequestInterface $request, ResponseInterface $response, $arguments = null)
    {
        // Nada que hacer despuรฉs
    }
}
```

## ๐ Routing (Enrutamiento)

**Archivo**: `app/Config/Routes.php`

```php
<?php

$routes->setDefaultNamespace('App\Controllers');
$routes->setDefaultController('Home');
$routes->setDefaultMethod('index');

// Frontend Routes
$routes->get('/', 'Home::index');
$routes->get('productos', 'ProductoController::index');
$routes->get('productos/(:num)', 'ProductoController::detalle/$1');
$routes->get('contacto', 'ContactoController::index');
$routes->post('contacto', 'ContactoController::enviar');

// Auth Routes
$routes->get('login', 'LoginController::index');
$routes->post('login', 'LoginController::authenticate');
$routes->get('logout', 'LoginController::logout');
$routes->get('registro', 'RegistroController::index');
$routes->post('registro', 'RegistroController::crear');

// Carrito Routes (requiere cliente)
$routes->group('carrito', ['filter' => 'auth:2'], function($routes) {
    $routes->get('/', 'CarritoController::index');
    $routes->post('agregar', 'CarritoController::agregar');
    $routes->post('actualizar', 'CarritoController::actualizar');
    $routes->post('eliminar', 'CarritoController::eliminar');
    $routes->get('checkout', 'CarritoController::checkout');
    $routes->post('confirmar', 'CarritoController::confirmar');
});

// Admin Routes (requiere administrador)
$routes->group('admin', ['filter' => 'auth:1'], function($routes) {
    $routes->get('/', 'AdminController::dashboard');
    $routes->get('dashboard', 'AdminController::dashboard');

    // Usuarios
    $routes->resource('usuarios', ['controller' => 'UsuarioCrudController']);

    // Productos
    $routes->resource('productos', ['controller' => 'ProductoController']);

    // Ventas
    $routes->get('ventas', 'VentasController::admin');
    $routes->get('ventas/(:num)', 'VentasController::detalle/$1');

    // Reportes
    $routes->get('reportes', 'ReportesController::index');
    $routes->get('reportes/ventas', 'ReportesController::ventas');
    $routes->get('reportes/productos', 'ReportesController::productos');
});

// API Routes
$routes->group('api', function($routes) {
    $routes->resource('productos', ['controller' => 'API\ProductsController']);
    $routes->resource('usuarios', ['controller' => 'API\UsersController']);

    $routes->post('auth/login', 'API\AuthController::login');
    $routes->post('auth/logout', 'API\AuthController::logout');
});
```

## ๐ Beneficios de la Arquitectura MVC

### โ Ventajas

1. **Separaciรณn de Responsabilidades**

   - Cada componente tiene una funciรณn especรญfica
   - Facilita el mantenimiento y debugging

2. **Reutilizaciรณn de Cรณdigo**

   - Models pueden ser utilizados por mรบltiples Controllers
   - Views pueden ser compartidas entre diferentes actions

3. **Testabilidad**

   - Cada capa puede ser testada independientemente
   - Facilita unit testing y integration testing

4. **Escalabilidad**

   - Fรกcil agregar nuevas funcionalidades
   - Estructura preparada para crecimiento

5. **Mantenibilidad**
   - Cรณdigo organizado y fรกcil de entender
   - Cambios en una capa no afectan las otras

### ๐ Flujo de Datos

```
Request โ Router โ Filter โ Controller โ Model โ Database
                                    โ
Response โ View โ Controller โ Model โ Database
```

### ๐ Mejores Prรกcticas

1. **Controllers Delgados**: Mรญnima lรณgica de negocio
2. **Models Robustos**: Toda la lรณgica de datos y validaciรณn
3. **Views Limpias**: Solo presentaciรณn, sin lรณgica compleja
4. **Validaciรณn Consistente**: En Models y Controllers
5. **Logging Comprehensivo**: Para debugging y auditorรญa

---

**Yagaruete Camp** - Implementaciรณn profesional del patrรณn MVC ๐๏ธ
